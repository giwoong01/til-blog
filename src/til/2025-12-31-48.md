---
title: 캐시 스탬피드 현상
description: 캐시 스탬피드 현상이란?
date: 2025-12-31
tags: [캐시 스탬피드]
---

캐시 스탬피드 현상은 대규모 트래픽을 처리하는 시스템에서 캐시를 사용할 때 발생할 수 있는 가장 무서운 장애 상황 중 하나입니다.

다른 말로 Thundering Herd(우르르 몰려가는 무리) 문제라고 불립니다.

## 1. 현상의 정의

수많은 사용자가 동시에 요청하는 ‘Hot Key(인기 있는 데이터)’가 캐시에서 만료되는 순간, 수천~수만 개의 요청이 동시에 DB로 몰리면서 DB가 부하를 견디지 못하고 다운되는 현상입니다.

보통 Look-Aside 전략(캐시에 없으면 DB에서 조회)을 사용할 때 발생합니다.

## 2. 발생 시나리오

1. Hot Key 존재: ‘실시간 검색어 1위’나 ‘특가 상품 정보’처럼 초당 10,000명이 조회하는 데이터가 있습니다.
2. 캐시 만료(TTL End): 해당 데이터의 캐시 유효 시간이 끝났습니다.
3. 동시 요청 발생: 캐시가 사라진 바로 그 찰나의 순간(밀리초 단위)에 1,000명의 사용자가 접속했습니다.
4. 집단 Cache Miss: 1,000명의 요청 모두 캐시 데이터를 찾지 못합니다(Miss).
5. DB 폭격: 1,000개의 스레드가 동시에 “내가 DB에서 데이터를 가져와서 캐시를 갱신해야지!”라고 판단하고 DB로 쿼리를 날립니다.
6. 시스템 장애: DB는 순간적이 부하를 견디지 못하고 CPU가 100%를 치거나 커넥션 풀이 고갈되어 뻗어버립니다. (이후 서버도 연쇄적으로 다운됨)

## 3. 해결 방법

이 현상을 막기 위해 실무에서는 다음과 같은 기법들을 사용합니다.

### 1) 적절한 만료 시간 설정

가장 수학적인 해결책입니다.

- 원리: TTL이 완전히 끝나기 전에, 확률적으로 미리 캐시를 갱신하는 것입니다.
- 방법: 남은 만료 시간이 얼마 남지 않았을 때, 요청이 들어오면 “랜덤한 확률”로 이 요청을 당첨시켜서 DB조회를 시키고 캐시를 갱신합니다.
- 효과: 만료 시간이 되기 전에 누군가가 미리 갱신해두므로, 실제 만료 시점에는 이미 시간이 연장되어 있어 스탬피드가 발생하지 않습니다.

### 2) 뮤텍스 락 / 분산 락

“선착순 1명만 DB에 가라”는 방식입니다.

- 원리: Cache Miss가 발생했을 때, 바로 DB로 가지 않고 먼저 락(Lock) 획득을 시도합니다.
- 동작
  - 락을 획득한 단 1개의 요청만 DB에 가서 데이터를 가져오고 캐시를 갱신합니다.
  - 나머지 요청들은 잠시 대기하다가, 캐시가 갱신되면 그 데이터를 읽어갑니다.
- 단점
  - 다소 구현이 복잡하고, 락 대기 시간 동안 응답 속도가 약간 느려질 수 있습니다.

### 3) 외부 프로세스 갱신

애플리케이션 요청단에서 캐시를 갱신하지 못하게 하는 방식입니다.

- 원리: 사용자의 요청(트래픽)은 절대 캐시를 갱신하지 않습니다. 오직 캐시 읽기만 수행합니다.
- 방법: 별도의 백그라운드 프로세스가 주기적으로 돌면서 캐시 데이터를 갱신해 놓습니다.
- 장점: 스탬피드 현상이 원칙적으로 차단됩니다.
- 단점: 별도의 갱신 시스템을 구축해야 합니다.

## 정리

- 캐시 스템피드: 인기 있는 캐시가 만료되는 순간 DB로 요청이 폭주하여 서버가 죽는 현상
- 해결책
  - PER 알고리즘: 만료되기 전에 확률적으로 미리 갱신하기
  - Locking: 한 명만 DB에 보내기
  - 별도 갱신: 사용자는 읽기만 하고, 갱신은 봇이 하기

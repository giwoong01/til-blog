---
title: MySQL InnoDB에서 갭락과 넥스트키 락이란? 그리고 팬텀 리드를 방지하는 방법
description: MySQL InnoDB에서 갭락과 넥스트키 락이란 무엇이며, 어떻게 팬텀 리드를 방지할까요?
date: 2025-11-28
tags: [MySQL, 갭락, 넥스트키 락, 팬텀 리드]
---

## REPEATABLE READ, 반복 가능한 읽기

`REPEATABLE READ` 는 데이터베이스 트랜잭션 격리 수준의 4단계 중 하나로, 하나의 트랜잭션 내에서 동일한 데이터를 여러 번 조회하더라도 항상 동일한 결과를 반환함을 보장하는 수준입니다.

이는 MySQL의 InnoDB 스토리지 엔진이 채택하고 있는 기본 격리 수준이기도 합니다.

### 핵심 개념 및 보장 내용

이 격리 수준의 가장 중요한 특징은 “트랜잭션이 시작된 시점(혹은 첫 번째 조회를 한 시점)의 상태를 끝까지 유지한다”는 것입니다.

- 동작 원리: 트랜잭션 T1이 데이터를 읽는 동안, 다른 트랜잭션 T2가 해당 데이터를 수정하고 커밋하더라도, T1은 T2가 수정한 값을 보지 못하고 자신이 처음 읽었던 과거의 데이터를 계속 봅니다.
- 방지하는 문제
  - Dirty Read: 커밋되지 않은 데이터를 읽는 문제 방지
  - Non-Repeatable Read: 같은 쿼리를 두 번 실행했을 때 값이 달라지는 문제 방지

### 구현 원리: MVCC (Mulit-Version Concurrency Control)

RDBMS(특히 MySQL InnoDB)는 이 기능을 구현하기 위해 락(Lock)을 걸어 다른 트랜잭션을 차단하는 방식 대신, MVCC 기술을 사용합니다.

1. 트랜잭션 번호: 모든 트랜잭션은 고유한 증가 번호를 가집니다.
2. Undo Log: 데이터가 수정될 때, 수정 전의 원본 데이터를 Undo Log라는 별도의 영역에 백업해 둡니다.
3. 스냅샷 읽기
   - `REPEATABLE READ` 트랜젹션이 시작되면, 시스템은 현재 시점의 데이터베이스 상태에 대한 논리적 스냅샷을 생성합니다.
   - 트랜잭션 내부에서 SELECT를 수행하면, 실제 데이터 테이블이 아니라 자신의 트랜잭션 번호보다 이전에 커밋된 데이터만을 Undo Log에서 재구성하여 읽습니다.
   - 따라서 다른 트랜잭션이 아무리 데이터를 바꿔도, Undo Log에 남아있는 과거 버전을 읽으므로 일관성이 유지됩니다.

MySQL의 InnoDB 스토리지 엔진은 `REPEATABLE READ` 격리 수준에서 팬텀 리드와 같은 동시성 문제를 해결하기 위해 넥스트 키 락이라는 고유한 잠금 방식을 사용합니다.

## 1. 넥스트 키 락 (Next-Key-Lock): 정의 및 구성 요소

넥스트 키 락은 InnoDB에서 범위 검색시 발생하는 동시성 문제를 해결하기 위한 기본 잠금 메커니즘입니다.

이는 사실 두 가지 유형의 락이 결합된 형태입니다.

1. 레코드 락: 이미 존재하는 인덱스 레코드 자체에 거는 잠금입니다. 이 락은 해당 레코드의 수정이나 삭제를 막습니다.
2. 갭 락: 인덱스 레코드 사이의 공간에 거는 잠금입니다. 이 락은 해당 공간에 새로운 레코드의 삽입을 막습니다.

넥스트 키 락 = 레코드 락 + 갭 락

넥스트 키 락은 인덱스 레코드 R이 있을 때, 바로 앞 인덱스 레코드와의 사이 공간과 레코드 R 자체를 잠급니다. (일반적으로 구간 (L, R]를 잠근다고 표현합니다.)

## 2. 갭 락 (Gap Lock): 팬텀 리드 방지의 핵심

갭 락은 InnoDB에만 존재하는 독특한 잠금 방식이며, 팬텀 리드를 방지하는 핵심 역할을 수행합니다.

- 목적: 삽입 방지
- 특징: 갭 락은 인덱스 레코드 자체가 아닌 “인덱스 간의 논리적 순서 공간”에 걸립니다. 갭 락끼리는 충돌하지 않으므로, 여러 트랜잭션이 동일한 간격에 갭 락을 걸 수 있습니다. 하지만 이 간격에 데이터를 삽입하려는 트랜잭션의 배타 락(X-Lock)을 차단합니다.
- 특수 갭 락: 인덱스의 맨 처음 레코드 이전 공강이나, 맨 마지막 레코드 이후 공간에도 갭 락이 적용됩니다.

## 3. 넥스트 키 락이 팬텀 리드를 방지하는 원리

팬텀 리드는 한 트랜잭션 T1이 특정 범위의 데이터를 조회했을 때, 다른 트랜잭션 T2가 해당 범위에 새로운 데이터를 삽입하고 커밋하여, T1이 재조회했을 때 이 새로운 유령 행이 나타나는 현상입니다.

넥스트 키 락은 이 삽입 행위를 원천적으로 차단하여 팬텀 리드를 방지합니다.

1. 트랜잭션 T1 시작: T1이 `SELECT … WHERE id BETWEEN 10 AND 20 FOR UPDATE;` 와 같은 잠금 쿼리를 실행합니다.
2. 넥스트 키 락 적용: InnoDB는 해당 쿼리 범위 내의 모든 존재하는 레코드에 레코드 락을 걸고, 레코드 사이의 모든 공간에도 갭 락을 겁니다.
3. 트랜잭션 T2의 삽입 시도: 이때 T2가 해당 범위 내의 빈 공간에 새로운 레코드를 삽입하려고 시도합니다.
4. 갭 락의 차단: T2의 삽입 시도는 T1이 걸어둔 갭 락에 의해 차단되고 대기 상태에 빠집니다.
5. 팬텀리드 방지: T1이 작업을 마치고 커밋하여 락을 해제하기 전까지 T2는 삽입을 완료할 수 없습니다. 따라서 T1이 같은 범위를 다시 조회해도 새로운 행이 나타날 수 없으며, 이로서 `REPEATABLE READ` 격리 수준에서도 팬텀 리드가 방지되고 직렬성에 가까운 무결성이 유지됩니다.

## 정리

넥스트 키 락은 레코드 락으로 기존 데이터의 변경을 막고, 갭 락으로 범위 내의 새로운 데이터 삽입을 막아 팬텀 리드를 완벽하게 해결합니다.
